@page
@model IndexModel
@{
    ViewData["Title"] = "Ø³ÛŒØ³ØªÙ… Ù†Ø¸Ø§Ø±Øª Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ Ù‡ÙˆØ´Ù…Ù†Ø¯";
}
    <div class="header">
        <h1>ğŸ­ Ø³ÛŒØ³ØªÙ… Ù†Ø¸Ø§Ø±Øª Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ Ù‡ÙˆØ´Ù…Ù†Ø¯ ØµÙ†Ø¹ØªÛŒ</h1>
        <div class="status-bar">
            <div class="status-item status-online" id="systemStatus">
                <span>ğŸŸ¢ ONLINE</span>
            </div>
            <div class="status-item status-automatic" id="systemMode">
                <span>ğŸ¤– AUTOMATIC MODE</span>
            </div>
            <div class="status-item" id="lastUpdate">
                <span id="timestamp">â° Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: --:--:--</span>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Warning Lights Section -->
        <div class="warning-lights">
            <div class="warning-light">
                <div class="light-indicator off" id="warningLight">
                </div>
                <div class="light-label">ğŸ’¡ Ú†Ø±Ø§Øº Ù‡Ø´Ø¯Ø§Ø± Ø¹Ù…ÙˆÙ…ÛŒ</div>
                <div class="warning-messages" id="warningMessages">
                    <div style="text-align: center; color: #666;">Ø¨Ø¯ÙˆÙ† Ù‡Ø´Ø¯Ø§Ø±</div>
                </div>
            </div>
            
            <div class="warning-light">
                <div class="light-indicator off" id="alarmLight">
                </div>
                <div class="light-label">ğŸš¨ Ø¢Ú˜ÛŒØ± Ùˆ Ú†Ø±Ø§Øº Ø®Ø·Ø± Ø§ØµÙ„ÛŒ</div>
                <div class="alarm-messages" id="alarmMessages">
                    <div style="text-align: center; color: #666;">ÙˆØ¶Ø¹ÛŒØª Ø¹Ø§Ø¯ÛŒ</div>
                </div>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Temperature & Environmental -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">ğŸŒ¡ï¸</div>
                    <div class="card-title">Ø¯Ù…Ø§ Ùˆ Ù…Ø­ÛŒØ· Ø²ÛŒØ³Øª</div>
                </div>
                <div class="sensor-grid" id="temperatureGrid">
                    <!-- Will be populated by JavaScript -->
                </div>
                <div class="chart-container">
                    <canvas id="temperatureChart"></canvas>
                </div>
            </div>

            <!-- Safety Sensors -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">âš ï¸</div>
                    <div class="card-title">Ø³Ù†Ø³ÙˆØ±Ù‡Ø§ÛŒ Ø§ÛŒÙ…Ù†ÛŒ</div>
                </div>
                <div class="sensor-grid" id="safetyGrid">
                    <!-- Will be populated by JavaScript -->
                </div>
                <div class="chart-container">
                    <canvas id="safetyChart"></canvas>
                </div>
            </div>

            <!-- Production Line -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">ğŸ­</div>
                    <div class="card-title">Ø®Ø· ØªÙˆÙ„ÛŒØ¯</div>
                </div>
                <div class="sensor-grid" id="productionGrid">
                    <!-- Will be populated by JavaScript -->
                </div>
                <div class="chart-container">
                    <canvas id="productionChart"></canvas>
                </div>
            </div>

            <!-- Electrical Systems -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">âš¡</div>
                    <div class="card-title">Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§ÛŒ Ø¨Ø±Ù‚ÛŒ</div>
                </div>
                <div class="sensor-grid" id="electricalGrid">
                    <!-- Will be populated by JavaScript -->
                </div>
                <div class="chart-container">
                    <canvas id="electricalChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Factory Layout -->
        <div class="factory-layout">
            <div class="card-header">
                <div class="card-icon">ğŸ—ï¸</div>
                <div class="card-title">Ù†Ù‚Ø´Ù‡ Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ Ùˆ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø³Ù†Ø³ÙˆØ±Ù‡Ø§</div>
            </div>
            <div class="layout-grid" id="factoryLayout">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <div class="timestamp" id="fullTimestamp">
            Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: --
        </div>
    </div>

    <script>
        // Global variables
        let connection;
        let charts = {};
        let sensorData = {};
        let sensorLocations = [];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeSignalR();
            loadSensorLocations();
            loadCurrentData();
            initializeCharts();
        });

        // SignalR Connection
        async function initializeSignalR() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/sensorhub")
                .build();

            connection.start().then(function () {
                console.log("SignalR Connected");
            }).catch(function (err) {
                console.error("SignalR Connection Error: ", err);
            });

            connection.on("SensorDataUpdate", function (data) {
                updateDashboard(data);
            });
        }

        // Load sensor locations
        async function loadSensorLocations() {
            try {
                const response = await fetch('/api/sensor/locations');
                const result = await response.json();
                if (result.success) {
                    sensorLocations = result.data;
                    createFactoryLayout();
                }
            } catch (error) {
                console.error('Error loading sensor locations:', error);
            }
        }

        // Load current data
        async function loadCurrentData() {
            try {
                const response = await fetch('/api/sensor/current');
                const result = await response.json();
                if (result.success) {
                    updateDashboard(result.data);
                }
            } catch (error) {
                console.error('Error loading current data:', error);
            }
        }

        // Update dashboard with new data
        function updateDashboard(data) {
            sensorData = data;
            updateSensorGrids();
            updateWarningLights();
            updateCharts();
            updateTimestamp();
        }

        // Update sensor grids
        function updateSensorGrids() {
            const categories = {
                temperature: ['Furnace_Temp', 'Env_Humid', 'Light_Level'],
                safety: ['Gas_Methane', 'Gas_CO', 'Tank_Pressure', 'Flame_Status', 'Water_Leak'],
                production: ['Machine_Sound', 'Conveyor_Dist', 'Gate_Status', 'E_Stop_Button', 'Coolant_Valve'],
                electrical: ['Main_Current', 'Engine_Vibe', 'Input_Voltage']
            };

            Object.keys(categories).forEach(category => {
                const grid = document.getElementById(category + 'Grid');
                if (grid) {
                    grid.innerHTML = '';
                    categories[category].forEach(sensorKey => {
                        const sensor = sensorLocations.find(s => s.key === sensorKey);
                        if (sensor) {
                            // Try different possible property names for the sensor data
                            const value = sensorData[sensorKey] || 
                                         sensorData[sensorKey.toLowerCase()] || 
                                         sensorData[sensorKey.replace('_', '')] ||
                                         getSensorValue(sensorKey) || 0;
                            const sensorElement = createSensorElement(sensor, value);
                            grid.appendChild(sensorElement);
                        }
                    });
                }
            });
        }

        // Helper function to get sensor value with different naming conventions
        function getSensorValue(sensorKey) {
            // Convert PascalCase_With_Underscore to camelCase_with_underscore (ASP.NET Core default JSON serialization)
            const camelCaseKey = sensorKey.charAt(0).toLowerCase() + sensorKey.slice(1);
            
            // Try different property name formats in order of preference
            const possibleNames = [
                camelCaseKey,                        // furnace_Temp (ASP.NET Core default)
                sensorKey,                           // Furnace_Temp (original)
                convertToCamelCase(sensorKey),       // furnaceTemp
                sensorKey.toLowerCase(),             // furnace_temp
                sensorKey.replace('_', ''),          // FurnaceTemp
                sensorKey.toLowerCase().replace('_', ''), // furnacetemp
                convertToPascalCase(sensorKey)       // FurnaceTemp
            ];
            
            for (const name of possibleNames) {
                if (sensorData.hasOwnProperty(name) && sensorData[name] !== undefined && sensorData[name] !== null) {
                    return sensorData[name];
                }
            }
            
            // If still not found, return 0 (this is normal for sensors that haven't been initialized yet)
            return 0;
        }

        // Convert snake_case to camelCase
        function convertToCamelCase(str) {
            return str.replace(/_([a-z])/g, (match, letter) => letter.toUpperCase());
        }

        // Convert snake_case to PascalCase
        function convertToPascalCase(str) {
            return str.replace(/_([a-z])/g, (match, letter) => letter.toUpperCase())
                     .replace(/^[a-z]/, match => match.toUpperCase());
        }

        // Create sensor element
        function createSensorElement(sensor, value) {
            const div = document.createElement('div');
            div.className = 'sensor-item';
            div.style.setProperty('--sensor-color', sensor.color);
            
            let status = '';
            let statusClass = '';
            
            if (sensor.maxSafe !== null && value > sensor.maxSafe) {
                status = 'âš ï¸';
                statusClass = 'danger';
            } else if (sensor.minSafe !== null && value < sensor.minSafe) {
                status = 'âš ï¸';
                statusClass = 'warning';
            } else {
                status = 'âœ…';
                statusClass = 'normal';
            }

            div.innerHTML = `
                <div style="font-size: 1.5rem;">${sensor.icon}</div>
                <div class="sensor-value ${statusClass}">${value}</div>
                <div class="sensor-name">${sensor.name}</div>
                <div class="sensor-unit">${sensor.unit} ${status}</div>
            `;
            
            return div;
        }

        // Update warning lights
        function updateWarningLights() {
            const warningLight = document.getElementById('warningLight');
            const alarmLight = document.getElementById('alarmLight');
            const warningMessages = document.getElementById('warningMessages');
            const alarmMessages = document.getElementById('alarmMessages');

            // Get warning and alarm status with different possible property names
            const warningLED = sensorData.warning_LED || sensorData.warningLED || sensorData.Warning_LED || false;
            const alarmSystem = sensorData.alarm_System || sensorData.alarmSystem || sensorData.Alarm_System || false;
            const activeWarnings = sensorData.activeWarnings || sensorData.ActiveWarnings || [];
            const activeAlarms = sensorData.activeAlarms || sensorData.ActiveAlarms || [];

            // Update warning light
            if (warningLED || activeWarnings.length > 0) {
                warningLight.className = 'light-indicator warning-on';
                warningMessages.innerHTML = activeWarnings.map(msg => 
                    `<div class="message-item">${msg}</div>`
                ).join('') || '<div class="message-item">Ù‡Ø´Ø¯Ø§Ø± ÙØ¹Ø§Ù„</div>';
            } else {
                warningLight.className = 'light-indicator off';
                warningMessages.innerHTML = '<div style="text-align: center; color: #666;">Ø¨Ø¯ÙˆÙ† Ù‡Ø´Ø¯Ø§Ø±</div>';
            }

            // Update alarm light
            if (alarmSystem || activeAlarms.length > 0) {
                alarmLight.className = 'light-indicator alarm-on';
                alarmMessages.innerHTML = activeAlarms.map(msg => 
                    `<div class="message-item">${msg}</div>`
                ).join('') || '<div class="message-item">Ø¢Ù„Ø§Ø±Ù… ÙØ¹Ø§Ù„</div>';
            } else {
                alarmLight.className = 'light-indicator off';
                alarmMessages.innerHTML = '<div style="text-align: center; color: #666;">ÙˆØ¶Ø¹ÛŒØª Ø¹Ø§Ø¯ÛŒ</div>';
            }
        }

        // Initialize charts
        function initializeCharts() {
            const chartConfigs = {
                temperatureChart: {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Ø¯Ù…Ø§ÛŒ Ú©ÙˆØ±Ù‡ (Â°C)',
                            data: [],
                            borderColor: '#FF6B6B',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: getChartOptions('Ø¯Ù…Ø§ Ùˆ Ù…Ø­ÛŒØ· Ø²ÛŒØ³Øª')
                },
                safetyChart: {
                    type: 'bar',
                    data: {
                        labels: ['Ú¯Ø§Ø² Ù…ØªØ§Ù†', 'Ù…ÙˆÙ†ÙˆÚ©Ø³ÛŒØ¯ Ú©Ø±Ø¨Ù†', 'ÙØ´Ø§Ø± Ù…Ø®Ø²Ù†'],
                        datasets: [{
                            label: 'Ø³Ø·Ø­ Ø®Ø·Ø±',
                            data: [0, 0, 0],
                            backgroundColor: ['#FF8E53', '#A8E6CF', '#98D8C8']
                        }]
                    },
                    options: getChartOptions('Ø³Ù†Ø³ÙˆØ±Ù‡Ø§ÛŒ Ø§ÛŒÙ…Ù†ÛŒ')
                },
                productionChart: {
                    type: 'doughnut',
                    data: {
                        labels: ['ØµØ¯Ø§ÛŒ Ù…Ø§Ø´ÛŒÙ†â€ŒØ¢Ù„Ø§Øª', 'ÙØ§ØµÙ„Ù‡ Ù†ÙˆØ§Ø± Ù†Ù‚Ø§Ù„Ù‡', 'Ø´ÛŒØ± Ø®Ù†Ú©â€ŒÚ©Ù†Ù†Ø¯Ù‡'],
                        datasets: [{
                            data: [0, 0, 0],
                            backgroundColor: ['#DDA0DD', '#F8C471', '#76D7C4']
                        }]
                    },
                    options: getChartOptions('Ø®Ø· ØªÙˆÙ„ÛŒØ¯')
                },
                electricalChart: {
                    type: 'radar',
                    data: {
                        labels: ['Ø¬Ø±ÛŒØ§Ù† Ø§ØµÙ„ÛŒ', 'Ù„Ø±Ø²Ø´ Ù…ÙˆØªÙˆØ±', 'ÙˆÙ„ØªØ§Ú˜ ÙˆØ±ÙˆØ¯ÛŒ'],
                        datasets: [{
                            label: 'Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§ÛŒ Ø¨Ø±Ù‚ÛŒ',
                            data: [0, 0, 0],
                            borderColor: '#F7DC6F',
                            backgroundColor: 'rgba(247, 220, 111, 0.2)'
                        }]
                    },
                    options: getChartOptions('Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§ÛŒ Ø¨Ø±Ù‚ÛŒ')
                }
            };

            Object.keys(chartConfigs).forEach(chartId => {
                const ctx = document.getElementById(chartId);
                if (ctx) {
                    charts[chartId] = new Chart(ctx, chartConfigs[chartId]);
                }
            });
        }

        // Get chart options
        function getChartOptions(title) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: title,
                        font: {
                            family: 'Vazirmatn',
                            size: 16,
                            weight: 'bold'
                        }
                    },
                    legend: {
                        labels: {
                            font: {
                                family: 'Vazirmatn'
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            font: {
                                family: 'Vazirmatn'
                            }
                        }
                    },
                    y: {
                        ticks: {
                            font: {
                                family: 'Vazirmatn'
                            }
                        }
                    }
                }
            };
        }

        // Update charts
        function updateCharts() {
            if (charts.temperatureChart) {
                const now = new Date().toLocaleTimeString('fa-IR');
                charts.temperatureChart.data.labels.push(now);
                charts.temperatureChart.data.datasets[0].data.push(getSensorValue('Furnace_Temp'));
                
                if (charts.temperatureChart.data.labels.length > 20) {
                    charts.temperatureChart.data.labels.shift();
                    charts.temperatureChart.data.datasets[0].data.shift();
                }
                charts.temperatureChart.update();
            }

            if (charts.safetyChart) {
                charts.safetyChart.data.datasets[0].data = [
                    getSensorValue('Gas_Methane'),
                    getSensorValue('Gas_CO'),
                    getSensorValue('Tank_Pressure')
                ];
                charts.safetyChart.update();
            }

            if (charts.productionChart) {
                charts.productionChart.data.datasets[0].data = [
                    getSensorValue('Machine_Sound'),
                    getSensorValue('Conveyor_Dist'),
                    getSensorValue('Coolant_Valve')
                ];
                charts.productionChart.update();
            }

            if (charts.electricalChart) {
                charts.electricalChart.data.datasets[0].data = [
                    getSensorValue('Main_Current'),
                    getSensorValue('Engine_Vibe'),
                    getSensorValue('Input_Voltage')
                ];
                charts.electricalChart.update();
            }
        }

        // Create factory layout
        function createFactoryLayout() {
            const layout = document.getElementById('factoryLayout');
            if (!layout) return;

            const areas = {};
            sensorLocations.forEach(sensor => {
                if (!areas[sensor.area]) {
                    areas[sensor.area] = [];
                }
                areas[sensor.area].push(sensor);
            });

            layout.innerHTML = '';
            Object.keys(areas).forEach(areaName => {
                const areaDiv = document.createElement('div');
                areaDiv.className = 'area-section';
                
                const title = document.createElement('div');
                title.className = 'area-title';
                title.textContent = areaName;
                
                const sensorsDiv = document.createElement('div');
                sensorsDiv.className = 'area-sensors';
                
                areas[areaName].forEach(sensor => {
                    const sensorDiv = document.createElement('div');
                    sensorDiv.className = 'area-sensor';
                    sensorDiv.style.setProperty('--sensor-color', sensor.color);
                    sensorDiv.innerHTML = `
                        <span>${sensor.icon}</span>
                        <span>${sensor.name}</span>
                    `;
                    sensorsDiv.appendChild(sensorDiv);
                });
                
                areaDiv.appendChild(title);
                areaDiv.appendChild(sensorsDiv);
                layout.appendChild(areaDiv);
            });
        }

        // Update timestamp
        function updateTimestamp() {
            const now = new Date();
            const persianTime = now.toLocaleString('fa-IR');
            
            document.getElementById('timestamp').textContent = `â° Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ${persianTime}`;
            document.getElementById('fullTimestamp').textContent = `Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ${persianTime}`;
        }

        // Update every 30 seconds
        setInterval(loadCurrentData, 30000);
    </script>